#!/bin/bash
# imessages-ai â€” ChatGPT auto-responder for iMessage
# https://github.com/maxawad/imessages-ai
set -euo pipefail

VERSION="1.0.0"
CONFIG_DIR="$HOME/.config/imessages-ai"
CONFIG_FILE="$CONFIG_DIR/config"
LOG_DIR="$HOME/Library/Logs/imessages-ai"
PLIST_LABEL="com.maxawad.imessages-ai"
PLIST_PATH="$HOME/Library/LaunchAgents/${PLIST_LABEL}.plist"

# Resolve the lib directory relative to this script
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"

# ---- Colors ----
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

print_header() {
    echo ""
    echo -e "${BOLD}iMessages AI${NC} v${VERSION}"
    echo -e "ChatGPT-powered auto-responder for iMessage"
    echo ""
}

# =====================================================================
# setup â€” interactive first-run configuration
# =====================================================================
cmd_setup() {
    print_header

    mkdir -p "$CONFIG_DIR"
    mkdir -p "$LOG_DIR"

    # ---- Step 1: OpenAI API key ----
    echo -e "${BOLD}Step 1/4: OpenAI API Key${NC}"
    EXISTING_KEY=""
    if [ -f "$CONFIG_FILE" ]; then
        EXISTING_KEY=$(grep "^OPENAI_API_KEY=" "$CONFIG_FILE" 2>/dev/null | cut -d= -f2 || true)
    fi
    if [ -n "$EXISTING_KEY" ]; then
        echo -e "  Current key: ${EXISTING_KEY:0:12}...${EXISTING_KEY: -4}"
        read -rp "  Keep existing key? [Y/n] " keep_key
        if [[ "$keep_key" =~ ^[Nn] ]]; then
            EXISTING_KEY=""
        fi
    fi
    if [ -z "$EXISTING_KEY" ]; then
        read -rp "  Enter your OpenAI API key (sk-...): " api_key
        if [ -z "$api_key" ]; then
            echo -e "${RED}  Error: API key is required.${NC}"
            exit 1
        fi
        EXISTING_KEY="$api_key"
    fi

    # ---- Step 2: Model ----
    echo ""
    echo -e "${BOLD}Step 2/4: Model${NC}"
    echo "  Available: gpt-4o, gpt-4o-mini, gpt-4-turbo, gpt-3.5-turbo"
    read -rp "  Model [gpt-4o]: " model
    model="${model:-gpt-4o}"

    # ---- Step 3: Trigger prefix ----
    echo ""
    echo -e "${BOLD}Step 3/4: Trigger Prefix${NC}"
    echo "  Messages starting with this prefix will trigger ChatGPT."
    read -rp "  Prefix [@]: " prefix
    prefix="${prefix:-@}"

    # ---- Step 4: Italic formatting ----
    echo ""
    echo -e "${BOLD}Step 4/4: Italic Formatting${NC}"
    echo "  Replies can be sent in ð‘–ð‘¡ð‘Žð‘™ð‘–ð‘ Unicode so they stand out."
    read -rp "  Enable italic? [Y/n]: " italic_choice
    if [[ "$italic_choice" =~ ^[Nn] ]]; then
        italic="false"
    else
        italic="true"
    fi

    # ---- Write config ----
    cat > "$CONFIG_FILE" <<EOF
# iMessages AI configuration
# Docs: https://github.com/maxawad/imessages-ai

OPENAI_API_KEY=${EXISTING_KEY}
MODEL=${model}
MAX_TOKENS=1024
TRIGGER_PREFIX=${prefix}
POLL_INTERVAL=2
ITALIC=${italic}
EOF
    chmod 600 "$CONFIG_FILE"

    echo ""
    echo -e "${GREEN}âœ“ Config saved to ${CONFIG_FILE}${NC}"

    # ---- Full Disk Access check ----
    echo ""
    echo -e "${BOLD}Important: Full Disk Access${NC}"
    if python3 -c "
import sqlite3, os
db = os.path.expanduser('~/Library/Messages/chat.db')
sqlite3.connect(f'file:{db}?mode=ro', uri=True).execute('SELECT 1 FROM message LIMIT 1')
" 2>/dev/null; then
        echo -e "  ${GREEN}âœ“ Messages database is accessible${NC}"
    else
        echo -e "  ${RED}âœ— Cannot read Messages database${NC}"
        echo -e "  ${YELLOW}â†’ System Settings > Privacy & Security > Full Disk Access${NC}"
        echo -e "  ${YELLOW}  Enable access for your terminal app (Terminal, iTerm, etc.)${NC}"
    fi

    echo ""
    echo -e "${GREEN}Setup complete!${NC}"
    echo ""
    echo "  Start listening:   imessages-ai start"
    echo "  Run in foreground: imessages-ai run"
    echo "  Check status:      imessages-ai status"
    echo ""
}

# =====================================================================
# run â€” foreground mode
# =====================================================================
cmd_run() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${RED}Not configured. Run: imessages-ai setup${NC}"
        exit 1
    fi
    exec python3 "$LIB_DIR/imessages_ai.py"
}

# =====================================================================
# start â€” install & start launchd service
# =====================================================================
cmd_start() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${RED}Not configured. Run: imessages-ai setup${NC}"
        exit 1
    fi

    mkdir -p "$HOME/Library/LaunchAgents"
    mkdir -p "$LOG_DIR"

    # Find python3 path
    PYTHON3="$(which python3)"

    cat > "$PLIST_PATH" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${PLIST_LABEL}</string>
    <key>ProgramArguments</key>
    <array>
        <string>${PYTHON3}</string>
        <string>${LIB_DIR}/imessages_ai.py</string>
    </array>
    <key>WorkingDirectory</key>
    <string>${CONFIG_DIR}</string>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>${LOG_DIR}/stdout.log</string>
    <key>StandardErrorPath</key>
    <string>${LOG_DIR}/stderr.log</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/usr/local/bin:/usr/bin:/bin:/opt/homebrew/bin</string>
    </dict>
</dict>
</plist>
EOF

    launchctl unload "$PLIST_PATH" 2>/dev/null || true
    launchctl load "$PLIST_PATH"

    echo -e "${GREEN}âœ“ iMessages AI is running${NC}"
    echo "  Logs: tail -f $LOG_DIR/stderr.log"
    echo "  Stop: imessages-ai stop"
}

# =====================================================================
# stop â€” unload launchd service
# =====================================================================
cmd_stop() {
    if [ -f "$PLIST_PATH" ]; then
        launchctl unload "$PLIST_PATH" 2>/dev/null || true
        echo -e "${GREEN}âœ“ Stopped${NC}"
    else
        echo "Service is not installed."
    fi
}

# =====================================================================
# restart
# =====================================================================
cmd_restart() {
    cmd_stop
    sleep 1
    cmd_start
}

# =====================================================================
# status
# =====================================================================
cmd_status() {
    print_header

    # Config
    if [ -f "$CONFIG_FILE" ]; then
        model=$(grep "^MODEL=" "$CONFIG_FILE" | cut -d= -f2)
        prefix=$(grep "^TRIGGER_PREFIX=" "$CONFIG_FILE" | cut -d= -f2)
        italic=$(grep "^ITALIC=" "$CONFIG_FILE" | cut -d= -f2)
        echo -e "  Config:  ${GREEN}âœ“${NC} ${CONFIG_FILE}"
        echo "  Model:   $model"
        echo "  Trigger: $prefix"
        echo "  Italic:  $italic"
    else
        echo -e "  Config:  ${RED}âœ— Not configured (run: imessages-ai setup)${NC}"
    fi

    # Service
    if launchctl list "$PLIST_LABEL" &>/dev/null; then
        pid=$(launchctl list "$PLIST_LABEL" 2>/dev/null | awk 'NR==2{print $1}')
        echo -e "  Service: ${GREEN}âœ“ Running${NC} (PID: ${pid:-unknown})"
    else
        echo -e "  Service: ${YELLOW}â—‹ Not running${NC}"
    fi

    # Full Disk Access
    if python3 -c "
import sqlite3, os
db = os.path.expanduser('~/Library/Messages/chat.db')
sqlite3.connect(f'file:{db}?mode=ro', uri=True).execute('SELECT 1 FROM message LIMIT 1')
" 2>/dev/null; then
        echo -e "  DB:      ${GREEN}âœ“ Messages database accessible${NC}"
    else
        echo -e "  DB:      ${RED}âœ— No Full Disk Access${NC}"
    fi

    # Logs
    if [ -d "$LOG_DIR" ]; then
        echo "  Logs:    $LOG_DIR/"
    fi
    echo ""
}

# =====================================================================
# logs
# =====================================================================
cmd_logs() {
    if [ -f "$LOG_DIR/imessages-ai.log" ]; then
        tail -f "$LOG_DIR/imessages-ai.log"
    elif [ -f "$LOG_DIR/stderr.log" ]; then
        tail -f "$LOG_DIR/stderr.log"
    else
        echo "No logs found at $LOG_DIR/"
    fi
}

# =====================================================================
# uninstall
# =====================================================================
cmd_uninstall() {
    echo -e "${BOLD}Uninstalling iMessages AI...${NC}"
    cmd_stop 2>/dev/null || true
    rm -f "$PLIST_PATH"
    echo -e "  ${GREEN}âœ“${NC} Service removed"
    read -rp "  Delete config at $CONFIG_DIR? [y/N] " del_config
    if [[ "$del_config" =~ ^[Yy] ]]; then
        rm -rf "$CONFIG_DIR"
        echo -e "  ${GREEN}âœ“${NC} Config deleted"
    fi
    echo -e "${GREEN}Done.${NC}"
}

# =====================================================================
# help
# =====================================================================
cmd_help() {
    print_header
    echo "Usage: imessages-ai <command>"
    echo ""
    echo "Commands:"
    echo "  setup       Interactive first-run configuration"
    echo "  run         Run in foreground (Ctrl+C to stop)"
    echo "  start       Start as background service (launchd)"
    echo "  stop        Stop background service"
    echo "  restart     Restart background service"
    echo "  status      Show current status"
    echo "  logs        Tail the log file"
    echo "  uninstall   Remove service and optionally config"
    echo ""
    echo "Config: $CONFIG_FILE"
    echo "Logs:   $LOG_DIR/"
    echo ""
}

# =====================================================================
# Main
# =====================================================================
case "${1:-help}" in
    setup)     cmd_setup ;;
    run)       cmd_run ;;
    start)     cmd_start ;;
    stop)      cmd_stop ;;
    restart)   cmd_restart ;;
    status)    cmd_status ;;
    logs)      cmd_logs ;;
    uninstall) cmd_uninstall ;;
    -v|--version) echo "imessages-ai $VERSION" ;;
    -h|--help|help) cmd_help ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        cmd_help
        exit 1
        ;;
esac
